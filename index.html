<!DOCTYPE html>
<title>Conway's game of life</title>
<style>
body { background: #333; }
canvas { display: block; margin: 10px auto; background: #000; cursor: none; }
</style>
<script>
"use strict";

function main() {
  let canvas = document.body.appendChild(document.createElement("canvas"));
  let ctx = canvas.getContext("2d");
  let grid = new Grid(32);
  let renderer = new Renderer(grid, ctx, 800);
  
  canvas.onmouseenter = _ => {
    renderer.cursor.over = true;
  };
  
  canvas.onmouseleave = _ => {
    renderer.cursor.over = false;
    if (renderer.paused) renderer.render();
  };
  
  canvas.onmousemove = e => {
    if (renderer.cursor.over) {
      renderer.cursor.x = e.offsetX / renderer.unit |0;
      renderer.cursor.y = e.offsetY / renderer.unit |0;
      if (renderer.paused) renderer.render();
    }
  };
  
  canvas.onclick = e => {
    let x = e.offsetX / renderer.unit |0;
    let y = e.offsetY / renderer.unit |0;
    renderer.paused = true;
    grid.toggleCell(x, y);
    renderer.render();
  };
  
  canvas.contextmenu = e => {
    e.preventDefault();
    let x = e.offsetX / renderer.unit |0;
    let y = e.offsetY / renderer.unit |0;
    renderer.paused = false;
    grid.toggleCell(x, y);
  };
  
  requestAnimationFrame(function loop() {
    if (!renderer.paused) {
      grid.evolve();
      grid.calculateScores();
      renderer.render();
    }
    requestAnimationFrame(loop, canvas);
  }, canvas);
}

class Grid {
  constructor(size) {
    this.cells = create2DArray(size, size, 0);
    this.scores = create2DArray(size, size, 0);
  }
  
  evolve() {
    let size = this.size;
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        this.cells[y][x] =
          this.isAlive(x, y) ?
            !this.isDeath(x, y) :
             this.isBirth(x, y);
      }
    }
  }
  
  calculateScores() {
    let size = this.size;
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        this.scores[y][x] = this.calculateScore(x, y);
      }
    }
  }
  
  calculateScore(x, y) {
    let last = this.size - 1;
    return (
      (x === 0 ? this.cells[y][last] : this.cells[y][x - 1]) +
      (y === 0 ? this.cells[last][x] : this.cells[y - 1][x]) +
      (y === 0 && x === 0 ?
         this.cells[last][last] :
         this.cells[y - 1][x - 1]) +
      
      (x === last ? this.cells[y][0] : this.cells[y][x + 1]) +
      (y === last ? this.cells[0][x] : this.cells[y + 1][x]) +
      (y === last && x === last ?
         this.cells[0][0] :
         this.cells[y + 1][x + 1]) +

      (y === 0 && x === last ?
         this.cells[last][0] :
         this.cells[y + 1][x + 1]) +
      (y === last && x === 0 ?
         this.cells[0][last] :
         this.cells[y + 1][x + 1])
    );
  }
  
  toggleCell(x, y) {
    this.cells[y][x] ^= 1;
  }
  
  isAlive(x, y) { return this.cells[y][x] === 1; }
  isBirth(x, y) { return this.scores[y][x] === 3; }
  isDeath(x, y) { 
    let score = this.scores[y][x];
    return score < 2 || score > 3;
  }
}

class Renderer {
  constructor(grid, ctx, size) {
    this.grid = grid;
    this.ctx = ctx;
    this.size = ctx.canvas.width = ctx.canvas.height = size;
    this.cursor = { over: false, x: 0, y: 0 };
    this.paused = false;
    this.renderColors = true;
    this.renderBirths = true;
    this.renderDeaths = true;
    this.renderScores = true;
  }
  
  get canvas() { return this.ctx.canvas; }
  get unit() { return this.grid.size / this.size; }
  
  render() {
    let ctx = this.ctx;
    let grid = this.grid;
    let size = grid.size;
    ctx.clearRect(0, 0, this.size, this.size);
    for (let y = 0; y < size; y++) {
      for (let x = 0; x < size; x++) {
        this.renderCell(grid, ctx, x, y);
      }
    }
    if (this.cursor.over) {
      this.renderCursor(ctx);
    }
  }
  
  renderCursor(ctx) {
    ctx.strokeStyle = "dodgerblue";
    let unit = this.unit;
    ctx.strokeRect(this.cursor.x * unit, this.cursor.y * unit, unit, unit);
  }
  
  renderCell(grid, ctx, x, y) {
    let isAlive = grid.isAlive(x, y);
    let isBirth = !isAlive && grid.isBirth(x, y);
    let isDeath = isAlive && grid.isDeath(x, y);
    let score = grid.getScoreFor(x, y);
    let unit = this.unit;
    
    if (isAlive) {
      ctx.fillStyle =
        this.renderColors ?
        `hsl(${ score / 8 * 360|0 }, ${ score / 8 * 40 + 60 |0 }%, ${ score / 8 * 60 + 20 |0 }%)` :
        "white";
      ctx.fillRect(x * unit, y * unit, unit, unit);
    }
    
    if (this.renderBirths && isBirth) {
      ctx.fillStyle = "#333";
      ctx.fillRect(x * unit + 1, y * unit + 1, unit - 2, unit - 2);
    }
    
    if (this.renderDeaths && isDeath) {
      ctx.fillStyle = "rgba(0,0,0,0.1)";
      ctx.fillRect(x * unit + 2, y * unit + 2, unit - 4, unit - 4);
    }
    
    // TODO: score rendering
  }
}

window.onload = main;

function create2DArray(rowCount, colCount, defaultValue) {
  return Array.apply(null, Array(rowCount)).map(_ => {
    return Array.apply(null, Array(colCount)).map(_ => defaultValue);
  });
}

</script>
